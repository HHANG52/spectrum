# Spectrum   光谱仪

## 功能概述

本系统已集成完整的摄像头原始数据保存功能，支持Windows和Linux平台，可以保存摄像头的原始帧数据、处理后的图像以及录制视频文件。

## 主要特性

### 1. 跨平台支持
- **Windows**: 使用OpenCV VideoCapture获取原始Mat数据
- **Linux**: 使用FFmpeg管道获取原始BGRA数据

### 2. 灵活的保存选项
- **保存原始帧**: 可选择PNG/JPG/BMP格式
- **保存处理后图像**: 可选择是否保存灰度图等处理结果
- **录制视频文件**: 可选择是否录制MP4视频
- **保存BGRA数据**: Linux平台可选择保存原始二进制数据
- **录制信息**: 自动生成包含录制参数的文本文件

### 3. 用户界面控制
- 保存选项复选框（可独立选择各种保存格式）
- 图像格式选择下拉框
- 选择保存目录按钮
- 开始/停止录制按钮
- 录制状态实时显示
- 已录制帧数统计

## 使用方法

### 1. 准备工作
1. 启动应用程序
2. 选择摄像头设备
3. 点击"开始预览"按钮

### 2. 配置保存选项
1. 在左侧控制面板的"摄像头数据录制"部分
2. 根据需要勾选保存选项：
    - **保存原始帧**: 保存每一帧的二进制文件（推荐） 选择"启用帧结构"，系统将自动使用新的帧头帧尾结构。
    - **保存处理后图像**: 保存灰度图等处理结果（可选）
    - **录制视频文件**: 保存为MP4视频（可选）
   
<details>
<summary>帧结构设计</summary>

#### 帧头结构 (FrameHeader - 32字节)
```csharp
public struct FrameHeader
{
    public uint FrameSequence;      // 帧序号 (4字节)
    public long Timestamp;          // 时间戳 (8字节，Unix毫秒)
    public int Width;               // 画面宽度 (4字节)
    public int Height;              // 画面高度 (4字节)
    public int BrightestRow;        // 最亮行号 (4字节)
    public uint HeaderSize;         // 帧头大小 (4字节，固定32)
    public uint DataSize;           // 数据大小 (4字节)
}
```
#### 帧尾结构 (FrameFooter - 8字节)
```csharp
public struct FrameFooter
{
    public uint Checksum;           // CRC32校验和 (4字节)
    public uint FooterMarker;       // 帧尾标记 (4字节，0xDEADBEEF)
}
```
#### 单帧结构
```
[帧头 32字节] + [原始数据 N字节] + [帧尾 8字节]
```
#### 文件打包
- 每512个完整帧打包成一个二进制文件
- 文件命名格式：`frames_YYYYMMDD_HHmmss_###.bin`
- 文件填满后自动创建新文件继续存储
- 支持连续写入，确保数据完整性
</details>

### 3. 设置保存目录
1. 点击"选择保存目录"按钮
2. 在弹出的文件夹选择对话框中选择保存位置
3. 确认选择

### 4. 开始录制
1. 确保预览正在运行
2. 确认已配置保存选项
3. 点击"开始录制"按钮
4. 系统会根据选项创建相应的文件夹
5. 录制状态会显示为"录制中"

### 4. 停止录制
1. 点击"停止录制"按钮
2. 系统会显示录制完成信息和总帧数

### 5. 保存单张图像
1. 在预览运行时点击"保存相机图像"按钮
2. 系统会保存当前帧为PNG图像

